name: Auto Publish Articles

on:
  schedule:
    # ExÃ©cute tous les jours Ã  22h00 heure franÃ§aise (21h00 UTC en hiver, 20h00 UTC en Ã©tÃ©)
    # MODIFIÃ‰ POUR TEST - Ã€ remettre Ã  17h00 UTC aprÃ¨s le test
    - cron: '0 21 * * *'
  workflow_dispatch: # Permet de dÃ©clencher manuellement

permissions:
  contents: write # NÃ©cessaire pour push les changements

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # NÃ©cessaire pour git diff
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies (optional)
        working-directory: ./frontend
        run: npm ci || echo "âš ï¸ npm ci failed, but continuing as script only uses Node.js built-ins"
        continue-on-error: true
      
      - name: Run auto-publish script
        working-directory: ./frontend
        env:
          CI: true
        run: |
          set -e  # ArrÃªter en cas d'erreur
          echo "ðŸ“… Date du jour (UTC): $(date -u +%Y-%m-%d)"
          echo "ðŸ“… Date du jour (local): $(date +%Y-%m-%d)"
          echo "ðŸ“ Working directory: $(pwd)"
          echo "ðŸ“ Listing content/blog:"
          ls -la content/blog/ || echo "âš ï¸ content/blog directory not found"
          echo "ðŸ“ Listing content/blog/draft:"
          ls -la content/blog/draft/ || echo "âš ï¸ content/blog/draft directory not found"
          echo "ðŸ” VÃ©rification du script..."
          if [ ! -f scripts/auto-publish-articles.js ]; then
            echo "âŒ Script introuvable: scripts/auto-publish-articles.js"
            exit 1
          fi
          echo "âœ… Script trouvÃ©, exÃ©cution..."
          node scripts/auto-publish-articles.js --debug
          EXIT_CODE=$?
          echo "ðŸ“Š Script terminÃ© avec le code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Script failed with exit code $EXIT_CODE"
            exit 1
          fi
          echo "âœ… Script exÃ©cutÃ© avec succÃ¨s"
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code frontend/content/blog/ frontend/content/blog/draft/ || echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add frontend/content/blog/ frontend/content/blog/draft/
          git status
          git commit -m "ðŸ¤– Auto-publish articles scheduled for $(date +%Y-%m-%d)" || exit 0
          git push origin HEAD:main || git push
      
      - name: No changes
        if: steps.git-check.outputs.has_changes != 'true'
        run: echo "âœ… No articles to publish today"

